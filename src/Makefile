################################################################
# Configuration
################################################################

################
#### GHC

HC      = ghc
HC_OPTS = -package mtl -package pretty

################
#### PDFLaTeX

LATEXC = pdflatex
LATEXOPTS = -interaction=nonstopmode


################################################################
# Configuration
################################################################

SRCS := $(wildcard *.lhs) 
OBJS := $(SRCS:.lhs=.o) 

.SUFFIXES : .o .hs .hi .lhs .hc .s\
	    .hi-boot .lhs-boot .o-boot

################################################################
# Rules
################################################################

## Default rule:
#     * build dependency graph
#     * make Epigram binary
#     * make the literate document
all: 
	$(MAKE) depend 
	$(MAKE) Pig Epitome

## Dependency graph:
# Ask GHC to compute the dependency graph.
#
# This calls She on every source file, therefore it is painfully
# slow. Unless explicitly asked to, we avoid running it.
#
# The dependency graph is broken wrt. She aspects: the typical example
# is Features.lhs, which import code from Sigma for example. Changing
# Sigma.lhs causes the re-compilation of the (empty) file Sigma.lhs,
# without causing the re-compilation of Rules.lhs, for example.
depend : $(SRCS)
	$(HC) -M -dep-makefile .depend $(SRCS)
dep : depend

## Epigram:
# Link the Epigram binary. Rely on the dependency graph to compile the
# code. If the dependency graph doesn't exist or has changed, this
# will go wrong: "make dep" needs to be run to solve the issue.
#
# This might be broken, as She aspects seem to be ill-handled by the
# dependency graph generated by GHC.
Pig : .depend $(OBJS)
	rm -f $@
	$(HC) -o $@ $(HC_OPTS) $(OBJS)

## Literate code:
# Try to stop as soon as possible, but it's still 2-3
# compilations. Rely on "Epitome.tex" to translate the literate code
# to latex.
#
# Look at the "tome" for a quick but dirty compilation of the Epitome
Epitome : Epitome.tex Epitome.bib
	$(LATEXC) $(LATEXOPTS) Epitome
	bibtex Epitome
	$(LATEXC) $(LATEXOPTS) Epitome
	if egrep Rerun Epitome.log; then $(LATEXC) $(LATEXOPTS) Epitome; fi

Epitome.tex : $(SRCS) stuff.fmt
	lhs2TeX --poly Epitome.lhs -o Epitome.tex

## Literate code in LaTeX:
# Same, with 'latex'
dvi : Epitome.dvi
Epitome.dvi : Epitome.tex
	latex Epitome
	bibtex Epitome
	latex Epitome
	if egrep Rerun Epitome.log; then latex Epitome; fi


## Literate code (in a hurry):
# To quickly check that no LaTeX bug has been introduced.
#
# However, the generated document will be incomplete wrt. references,
# bibliography entries, etc.
Atome:
	lhs2TeX --poly Epitome.lhs -o Epitome.tex
	pdflatex Epitome

## Unit testing (haha):
test:
	cd ../test && ./test.sh

## Clean:
clean:
	rm -f *.o *.hers *.hi\
	      *.o-boot *.hi-boot\
	      *.aux *.bbl\
	      *.blg *.log *.ptb\
	      Epitome.tex \
	      Epitome.toc


################################################################
# Automatic rules
################################################################

## Include the dependency graph
-include .depend

## Standard suffix rules

.o.hi:
	@:

.lhs.o:
	$(HC) -c $< $(HC_OPTS)

.hs.o:
	$(HC) -c $< $(HC_OPTS)

.o-boot.hi-boot:
	@:

.lhs-boot.o-boot:
	$(HC) -c $< $(HC_OPTS)

.hs-boot.o-boot:
	$(HC) -c $< $(HC_OPTS)
